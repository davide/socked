<!doctype html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta HTTP-equiv="X-UA-Compatible" content="IE=EDGE">
    <title>Socked - Mouselive Sender</title>
    <script type="text/javascript" language="javascript" src="/javascript/sockjs-0.2.min.js"></script>
    <script type="text/javascript" language="javascript" src="/javascript/socked-0.1.js"></script>
</head>
<body>

<script type="text/javascript">

  // http://bitdaddys.com/javascript/example3run.html
  var trackMousePosition = function(period, callback){
    var isIE = document.all?true:false;
    if (!isIE) document.captureEvents(Event.MOUSEMOVE);
    var _x = null, _y = null;
    document.onmousemove = function (mp) {
      if (isIE) {
        _x = event.clientX + document.body.scrollLeft;
        _y = event.clientY + document.body.scrollTop;
      } else {
        _x = mp.pageX;
        _y = mp.pageY;
      }
      return true;
    };
    var sentX, sentY;
    return setInterval(function(){
      if ((_x !== sentX) && (_y !== sentY)) {
        sentX = _x;
        sentY = _y;
        callback(_x, _y);
      }
    }, period);
  };

  Socked.ready(function(){
    try {
      var host = window.location.host;
      Socked.createConnection({id:'s1', server:host, appKey:'myKey',
          channels: [{name:'mouselive'}]
        });
    } catch(e) {
      console.log('Error setting up connection!');
      return;
    }
    
    var subscriptionOptions = {role: "sender"};
    var channelRef = Socked.subscribe("s1", "mouselive", subscriptionOptions);

    var tracker = null;
    channelRef.onConnect(function() {
        console.log('connected to mouselive');
        var period = 25;
        tracker = trackMousePosition(period, function(x,y){
          var mousePosition = JSON.stringify([x,y]);
          channelRef.send(mousePosition);
        });
      }).onMessage(function(msg) {
      	// nothing to do here
      }).onDisconnect(function() {
        console.log('disconnected from mouselive');
        if (tracker != null) {
          clearInterval(tracker);
        }
      });
  });
</script>

</body>
</html>

