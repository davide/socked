<!doctype html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta HTTP-equiv="X-UA-Compatible" content="IE=EDGE">
    <title>Socked - Interests Example</title>
    <script type="text/javascript" language="javascript" src="javascript/sockjs-0.2.min.js"></script>
    <script type="text/javascript" language="javascript" src="javascript/socked-0.1.js"></script>
</head>
<body>

<script type="text/javascript">
  Socked.ready(function(){
  	try {
      var host = window.location.host;
      Socked.createConnection({id:'s1', server:host, appKey:'myKey',
          channels: [{name:'interestsChannel'}]
        });
      
      var setup = function(ref, name) {
        ref.onConnect(function() {
          console.log(name, ' connected');
        }).onMessage(function(msg) {
          console.log(name, ' got msg: {', msg.action,',', msg.user, '}');
        }).onDisconnect(function() {
          console.log(name, ' disconnected');
        });
      };
      
      var ref1 = Socked.subscribe('s1', 'interestsChannel', {role: 'both', interests: null})
      // here channelInterests should be null
      setup(ref1, 'c1');

      ref1.send({action:'x', user:'c1'});
      
      var ref2 = Socked.subscribe('s1', 'interestsChannel', {role: 'both', interests: ['a']})
      // here channelInterests should be null
      setup(ref2, 'c2');

      ref1.send({action:'x', user:'c1'});
      ref1.send({action:'y', user:'c1'});
      ref1.send({action:'a', user:'c1'});
      
      var ref3 = Socked.subscribe('s1', 'interestsChannel', {role: 'both', interests: ['b']})
      // here channelInterests should be null
      setup(ref3, 'c3');

      ref1.send({action:'x', user:'c1'});
      ref1.send({action:'y', user:'c1'});
      ref1.send({action:'a', user:'c1'});
      ref1.send({action:'b', user:'c1'});
 
      // the timeout below are required to give some time to receive the messages before unsubscribing
      setTimeout(function() {

        ref1.unsubscribe();
        // here channelInterests should be ['a', 'b']

        ref2.send({action:'x', user:'c2'});
        ref2.send({action:'y', user:'c2'});
        ref2.send({action:'a', user:'c2'});
        ref2.send({action:'b', user:'c2'});

        setTimeout(function() {

          ref2.unsubscribe();
          // here channelInterests should be ['b']

          ref3.send({action:'x', user:'c3'});
          ref3.send({action:'a', user:'c3'});
          ref3.send({action:'b', user:'c3'});
          
          setTimeout(function() {
          
            ref3.unsubscribe();
            // here channelInterests should be null
          
          }, 500);

        }, 500);

      }, 500);
                
    } catch(e) {
      console.log('Error setting up connection!');
      return;
    }
  });
</script>

</body>
</html>

